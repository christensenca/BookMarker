{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-3 bg-light p-3 border-end" style="max-height: calc(100vh - 70px); overflow-y: auto;">
            <h2>Books</h2>
            <div class="list-group">
                {% for book in books %}
                <a href="?book_id={{ book.id }}" class="list-group-item list-group-item-action">
                    <strong>{{ book.title }}</strong><br>
                    <small>by {{ book.author }}</small><br>
                    <small>Highlights: {{ book.highlight_count }}</small><br>
                    <small>Last: {% if book.last_highlight_date %}{% set date_str = book.last_highlight_date %}{% set year = date_str[0:4] %}{% set month = date_str[5:7] %}{% set day = date_str[8:10] %}{% set month_names = {'01':'Jan', '02':'Feb', '03':'Mar', '04':'Apr', '05':'May', '06':'Jun', '07':'Jul', '08':'Aug', '09':'Sep', '10':'Oct', '11':'Nov', '12':'Dec'} %}{{ day }} {{ month_names[month] }} {{ year }}{% else %}N/A{% endif %}</small>
                </a>
                {% endfor %}
            </div>
        </div>
        <div class="col-md-9 p-3 bg-white">
            <div class="mb-4">
                <form method="get" class="d-flex">
                    <input type="text" name="q" value="{{ query }}" placeholder="Search highlights, titles, authors..." class="form-control me-2">
                    <button type="submit" class="btn btn-primary">Search</button>
                    {% if query %}<a href="/" class="btn btn-secondary ms-2">Clear</a>{% endif %}
                </form>
            </div>
            {% if query %}
            <h1>Search Results for "{{ query }}"</h1>
            {% if highlights %}
            <div class="row">
                {% for highlight, book, highlighted_quote, highlighted_title, highlighted_author in highlights %}
                <div class="col-md-12 mb-3">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title">{{ highlighted_title | safe }} by {{ highlighted_author | safe }}</h5>
                            <p class="card-text">{{ highlighted_quote | safe }}</p>
                            <div class="mb-2">
                                <span id="tag-badges-{{ highlight.id }}">
                                {% for tag in highlight.tags %}
                                <span class="badge" style="background-color: hsl({{ (tag.name|length * 37) % 360 }}, 70%, 60%); color: white;">{{ tag.name }} <button class="btn btn-sm btn-link text-white p-0 ms-1" onclick="removeTag({{ highlight.id }}, {{ tag.id }})">×</button></span>
                                {% endfor %}
                                </span>
                                <button class="btn btn-sm btn-outline-primary ms-2" onclick="toggleTagManager({{ highlight.id }})"><i class="bi bi-plus"></i> Tags</button>
                                <div id="tag-manager-{{ highlight.id }}" class="mt-2 border rounded p-2 bg-light" style="display: none;">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <small class="text-muted">Manage Tags</small>
                                        <button class="btn btn-sm btn-outline-secondary" onclick="toggleTagManager({{ highlight.id }})">×</button>
                                    </div>
                                    <input type="text" class="form-control form-control-sm mb-2" placeholder="Search tags..." onkeyup="filterTags({{ highlight.id }}, this.value)">
                                    <div class="tag-checkboxes" id="tag-list-{{ highlight.id }}">
                                        {% for tag in all_tags %}
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input tag-checkbox" type="checkbox" value="{{ tag.id }}" id="tag{{ highlight.id }}-{{ tag.id }}" onchange="updateTag({{ highlight.id }}, {{ tag.id }}, this.checked)">
                                            <label class="form-check-label" for="tag{{ highlight.id }}-{{ tag.id }}">
                                                {{ tag.name }}
                                            </label>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                            <small class="text-muted">Type: {{ highlight.highlight_type }} | Location: {{ highlight.location }} | Date: {% if highlight.date_added %}{% set date_str = highlight.date_added %}{% set year = date_str[0:4] %}{% set month = date_str[5:7] %}{% set day = date_str[8:10] %}{% set month_names = {'01':'Jan', '02':'Feb', '03':'Mar', '04':'Apr', '05':'May', '06':'Jun', '07':'Jul', '08':'Aug', '09':'Sep', '10':'Oct', '11':'Nov', '12':'Dec'} %}{{ day }} {{ month_names[month] }} {{ year }}{% else %}N/A{% endif %}{% if highlight.page %} | Page: {{ highlight.page }}{% endif %}</small>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p>No results found.</p>
            {% endif %}
            {% elif selected_book %}
            <h1>{{ selected_book.title }}</h1>
            <h2>by {{ selected_book.author }}</h2>
            <div class="row">
                {% for highlight in highlights %}
                <div class="col-md-12 mb-3">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <p class="card-text">{{ highlight.quote }}</p>
                            <div class="mb-2">
                                <span id="tag-badges-{{ highlight.id }}">
                                {% for tag in highlight.tags %}
                                <span class="badge" style="background-color: hsl({{ (tag.name|length * 37) % 360 }}, 70%, 60%); color: white;">{{ tag.name }} <button class="btn btn-sm btn-link text-white p-0 ms-1" onclick="removeTag({{ highlight.id }}, {{ tag.id }})">×</button></span>
                                {% endfor %}
                                </span>
                                <button class="btn btn-sm btn-outline-primary ms-2" onclick="toggleTagManager({{ highlight.id }})"><i class="bi bi-plus"></i> Tags</button>
                                <div id="tag-manager-{{ highlight.id }}" class="mt-2 border rounded p-2 bg-light" style="display: none;">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <small class="text-muted">Manage Tags</small>
                                        <button class="btn btn-sm btn-outline-secondary" onclick="toggleTagManager({{ highlight.id }})">×</button>
                                    </div>
                                    <input type="text" class="form-control form-control-sm mb-2" placeholder="Search tags..." onkeyup="filterTags({{ highlight.id }}, this.value)">
                                    <div class="tag-checkboxes" id="tag-list-{{ highlight.id }}">
                                        {% for tag in all_tags %}
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input tag-checkbox" type="checkbox" value="{{ tag.id }}" id="tag{{ highlight.id }}-{{ tag.id }}" onchange="updateTag({{ highlight.id }}, {{ tag.id }}, this.checked)">
                                            <label class="form-check-label" for="tag{{ highlight.id }}-{{ tag.id }}">
                                                {{ tag.name }}
                                            </label>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                            <small class="text-muted">Type: {{ highlight.highlight_type }} | Location: {{ highlight.location }} | Date: {% if highlight.date_added %}{% set date_str = highlight.date_added %}{% set year = date_str[0:4] %}{% set month = date_str[5:7] %}{% set day = date_str[8:10] %}{% set month_names = {'01':'Jan', '02':'Feb', '03':'Mar', '04':'Apr', '05':'May', '06':'Jun', '07':'Jul', '08':'Aug', '09':'Sep', '10':'Oct', '11':'Nov', '12':'Dec'} %}{{ day }} {{ month_names[month] }} {{ year }}{% else %}N/A{% endif %}{% if highlight.page %} | Page: {{ highlight.page }}{% endif %}</small>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <h1>Select a book from the sidebar or search</h1>
            {% endif %}
        </div>
    </div>
</div>

<script>
function toggleTagManager(highlightId) {
    const manager = document.getElementById(`tag-manager-${highlightId}`);
    if (manager.style.display === 'none') {
        manager.style.display = 'block';
        // Load current tags
        fetch(`/get_tags_for_highlight?highlight_id=${highlightId}`)
            .then(response => response.json())
            .then(tags => {
                // Uncheck all first
                document.querySelectorAll(`#tag-list-${highlightId} .tag-checkbox`).forEach(cb => cb.checked = false);
                // Check current tags
                tags.forEach(tag => {
                    const cb = document.getElementById(`tag${highlightId}-${tag.id}`);
                    if (cb) cb.checked = true;
                });
            });
    } else {
        manager.style.display = 'none';
    }
}

function filterTags(highlightId, query) {
    const checkboxes = document.querySelectorAll(`#tag-list-${highlightId} .form-check`);
    const lowerQuery = query.toLowerCase();
    checkboxes.forEach(check => {
        const label = check.querySelector('.form-check-label');
        const text = label.textContent.toLowerCase();
        check.style.display = text.includes(lowerQuery) ? '' : 'none';
    });
}

function updateTag(highlightId, tagId, checked) {
    const url = checked ? '/add_tag_to_highlight' : '/remove_tag_from_highlight';
    fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `highlight_id=${highlightId}&tag_id=${tagId}`
    }).then(response => {
        if (response.ok) {
            updateTagDisplay(highlightId, tagId, checked);
        }
    });
}

function updateTagDisplay(highlightId, tagId, checked) {
    const tagContainer = document.getElementById(`tag-badges-${highlightId}`);
    const tagName = document.querySelector(`label[for="tag${highlightId}-${tagId}"]`).textContent.trim();
    const charSum = tagName.split('').reduce((sum, char) => sum + char.charCodeAt(0), 0);
    const hue = (charSum * 7) % 360;
    const color = `hsl(${hue}, 70%, 60%)`;
    
    if (checked) {
        // Add badge
        const badge = document.createElement('span');
        badge.className = 'badge me-1';
        badge.style.backgroundColor = color;
        badge.style.color = 'white';
        badge.innerHTML = `${tagName} <button class="btn btn-sm btn-link text-white p-0 ms-1" onclick="removeTag(${highlightId}, ${tagId})">×</button>`;
        tagContainer.appendChild(badge);
    } else {
        // Remove badge
        const badges = tagContainer.querySelectorAll('.badge');
        badges.forEach(badge => {
            if (badge.textContent.includes(tagName)) {
                badge.remove();
            }
        });
    }
}

function removeTag(highlightId, tagId) {
    fetch('/remove_tag_from_highlight', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `highlight_id=${highlightId}&tag_id=${tagId}`
    }).then(() => location.reload());
}

function openTagModal(highlightId) {
    document.getElementById('currentHighlightId').value = highlightId;
    // Reset all checkboxes
    document.querySelectorAll('.tag-checkbox').forEach(cb => cb.checked = false);
    // Fetch current tags for this highlight
    fetch(`/get_tags_for_highlight?highlight_id=${highlightId}`)
        .then(response => response.json())
        .then(tags => {
            tags.forEach(tag => {
                const cb = document.getElementById(`tag${tag.id}`);
                if (cb) cb.checked = true;
            });
        });
    new bootstrap.Modal(document.getElementById('tagModal')).show();
}

function saveTags() {
    const highlightId = document.getElementById('currentHighlightId').value;
    const checkedTags = Array.from(document.querySelectorAll('.tag-checkbox:checked')).map(cb => cb.value);
    
    // For simplicity, remove all and add checked ones
    // In a real app, you'd diff
    fetch('/update_highlight_tags', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ highlight_id: highlightId, tag_ids: checkedTags })
    }).then(() => {
        bootstrap.Modal.getInstance(document.getElementById('tagModal')).hide();
        location.reload();
    });
}
</script>
{% endblock %}